{% extends "layout.html" %}

{% block title %}Fireground Trainer{% endblock %}

{% block head_extra %}
<style>
  body { font-family: system-ui, Arial; margin: 0; background:#0e0f12; color:#f2f2f2; }
  header {
    padding: 14px;
    border-bottom: 1px solid #2a2f3c;
    position: sticky;
    top: 0;
    background: rgba(14,15,18,0.92);
    z-index: 20000;
  }
  main { max-width: 1200px; margin: 14px auto; padding: 0 14px; display: grid; gap: 14px; }
  .card { background:#161922; border:1px solid #2a2f3c; border-radius: 14px; padding: 14px; }
  .imgwrap {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #2a2f3c;
    touch-action: none;
  }

  .base-img {
    width: 100%;
    display: block;
    user-select: none;
    -webkit-user-drag: none;
  }

  .token-layer {
    position: absolute;
    inset: 0;
  }

  .token {
    position:absolute;
    transform: translate(-50%, -50%);
    font-size: 32px;
    cursor: grab;
    user-select: none;
    touch-action: none;
  }

  .token-img {
    width: 52px;
    height: 52px;
    object-fit: contain;
    display: block;
  }

  .token-inner {
    position: relative;
    display: inline-block;
  }

  .token-del {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid #2a2f3c;
    background: #0f121a;
    color: #f2f2f2;
    font-weight: 900;
    font-size: 14px;
    line-height: 20px;
    cursor: pointer;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .token-rot {
    position: absolute;
    bottom: -12px;
    right: -12px;
    width: 26px;
    height: 26px;
    border-radius: 999px;
    border: 1px solid #2a2f3c;
    background: #161922;
    color: #ffffff;
    font-weight: 900;
    font-size: 14px;
    cursor: grab;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .token-size {
    position: absolute;
    bottom: -12px;
    left: -12px;
    width: 26px;
    height: 26px;
    border-radius: 999px;
    border: 1px solid #2a2f3c;
    background: #161922;
    color: #ffffff;
    font-weight: 900;
    font-size: 12px;
    cursor: nwse-resize;
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .token.selected .token-del,
  .token.selected .token-rot,
  .token.selected .token-size {
    display: inline-flex;
  }

  .token.selected .token-inner {
    outline: 2px solid #2f6fed;
    outline-offset: 4px;
    border-radius: 10px;
  }

  .token:active {
    cursor: grabbing;
  }

  .toolbtn {
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid #2a2f3c;
    background: #0f121a;
    color: #f2f2f2;
    font-weight: 800;
    cursor: pointer;
  }

  #board {
    margin: 0 auto;
  }

  label { font-weight: 700; display:block; margin: 12px 0 6px; line-height:1.25; }
  textarea {
    width:100%;
    border-radius:12px;
    border:1px solid #2a2f3c;
    background:#0f121a;
    color:#f2f2f2;
    padding: 10px;
    font-size: 1rem;
    resize: vertical;
  }
  button { margin-top: 14px; padding: 10px 14px; border-radius: 12px; border: 0; font-weight: 800; cursor:pointer; }

  .workspace {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 100px;
    gap: 14px;
    align-items: start;
    grid-template-areas:
      "new tools"
      "scenario tools"
      "questions tools";
  }

  .new-card {
    grid-area: new;
  }

  .scenario-card {
    grid-area: scenario; min-width: 0;
  }

  .tools-panel {
    grid-area: tools;
    position: sticky;
    top: 80px;
    align-self: start;
  }

  .questions-card {
    grid-area: questions; min-width: 0;
  }

  @media (max-width: 980px) {
    .workspace {
      grid-template-columns: 1fr;
      grid-template-areas:
        "new"
        "scenario"
        "tools"
        "questions";
    }
    .tools-panel {
      position: static;
    }
  }
</style>
{% endblock %}

{% block body %}
<header>
  <div style="font-weight:800;">ðŸ”¥ Fireground Trainer</div>
  <div style="opacity:0.8;font-size:0.9rem;">Scenario drills â€¢ Size-up â€¢ Tactics â€¢ Pump ops</div>
</header>

<main class="workspace">
  <div class="card new-card">
    <a href="/new" style="
      display:inline-block;
      padding:10px 14px;
      border-radius:12px;
      background:#2a2f3c;
      border:1px solid #2a2f3c;
      color:#f2f2f2;
      font-weight:800;
      text-decoration:none;
    ">ðŸŽ² New Scenario</a>
  </div>

  <section class="card scenario-card">
    <h1 style="margin:0 0 8px;">{{ scenario.title }}</h1>
    <p style="margin:0 0 12px; opacity:0.85; line-height:1.35;">
      <strong>Dispatch:</strong> {{ scenario.dispatch }}
    </p>

    <div class="imgwrap" id="board" data-scenario-key="{{ scenario.title | e }}">
      <img class="base-img" src="{{ url_for('static', filename=scenario.image.base) }}" alt="Scenario house" />
      <div class="token-layer" id="tokenLayer"></div>
    </div>
    <p style="margin:10px 0 0; opacity:0.75; font-size:0.9rem;">
      (For now this is a single image-later we will add the fire overlay and street-view support.)
    </p>
  </section>

  <aside class="card tools-panel">
    <h2 style="margin: 0 0 10px;">Tools</h2>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 12px;">
      <button type="button" class="toolbtn tokenbtn" data-src="{{ url_for('static', filename='tokens/fire.png') }}" data-type="fire">Fire</button>
      <button type="button" class="toolbtn tokenbtn" data-src="{{ url_for('static', filename='tokens/smoke.png') }}" data-type="smoke">Smoke</button>
      <button type="button" class="toolbtn tokenbtn" data-src="{{ url_for('static', filename='tokens/wind_arrow.png') }}" data-type="wind">Wind</button>
      <button type="button" class="toolbtn tokenbtn" data-src="{{ url_for('static', filename='tokens/ladder.png') }}" data-type="ladder">Ladder</button>
      <button type="button" class="toolbtn tokenbtn" data-src="{{ url_for('static', filename='tokens/fireman.png') }}" data-type="attack">Attack</button>
      <button type="button" class="toolbtn tokenbtn" data-src="{{ url_for('static', filename='tokens/RIT.png') }}" data-type="rit">RIT</button>
      <button type="button" class="toolbtn" id="clearTokens">Clear</button>
    </div>

  </aside>

  <form class="card questions-card" method="post" action="/submit">
    <h2 style="margin:0 0 10px;">Questions</h2>

    {% for q in scenario.questions %}
      <div>
        <label for="{{ q.id }}">{{ loop.index }}. {{ q.prompt }}</label>
        <textarea id="{{ q.id }}" name="{{ q.id }}" rows="5" placeholder="Type your answer...">{{ answers.get(q.id, "") }}</textarea>
      </div>
    {% endfor %}

    <button type="submit">Submit</button>

    {% if submitted %}
      <p style="margin:10px 0 0; color:#9fe6b0;">Submitted. (MVP just echoes answers back.)</p>
    {% endif %}
  </form>
</main>
{% endblock %}

{% block page_scripts %}
<script src="{{ url_for('static', filename='js/board.js') }}"></script>
{% endblock %}
